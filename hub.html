<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Forge Hub - FrontlineOps Control Center">
    <title>Forge Hub | FrontlineOps V6.3.1</title>
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkZvcmdlIEh1YiIsCiAgInNob3J0X25hbWUiOiAiRm9yZ2UiLAogICJzdGFydF91cmwiOiAiL2h1Yi5odG1sIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMGEwZTE3IiwKICAidGhlbWVfY29sb3IiOiAiI2VjNDA3YSIKfQ==">
    <style>

        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #0a0e17; --surface: #1e293b; --border: #334155;
            --text: #f1f5f9; --text-secondary: #94a3b8;
            --primary: #3b82f6; --success: #10b981; --danger: #ef4444;
            --pink: #ec407a;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg); color: var(--text); min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, var(--pink) 0%, #d81b60 100%);
            padding: 20px 32px; display: flex; justify-content: space-between;
            align-items: center; border-bottom: 3px solid var(--pink);
        }
        .logo { font-size: 24px; font-weight: 700; color: white; }
        .version-badge {
            background: rgba(255,255,255,0.2); color: white;
            padding: 6px 12px; border-radius: 20px; font-size: 12px;
            font-weight: 600; cursor: pointer; transition: all 0.2s;
        }
        .version-badge:hover { background: rgba(255,255,255,0.3); }
        .status-dot {
            width: 10px; height: 10px; border-radius: 50%;
            background: var(--success); animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .container { max-width: 1400px; margin: 0 auto; padding: 32px; }
        .alert {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white; padding: 16px 24px; border-radius: 12px;
            margin-bottom: 24px; font-weight: 500;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px; margin-bottom: 32px;
        }
        .card {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 12px; padding: 20px; transition: all 0.2s;
        }
        .card:hover { border-color: var(--primary); }
        .card-title { font-size: 13px; color: var(--text-secondary);
            margin-bottom: 8px; text-transform: uppercase; font-weight: 600;
        }
        .card-value { font-size: 32px; font-weight: 700; margin-bottom: 4px; }
        .card-label { font-size: 13px; color: var(--text-secondary); }
        .section {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 12px; padding: 24px; margin-bottom: 20px;
        }
        .section-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; }
        .btn {
            background: var(--primary); color: white; border: none;
            padding: 12px 24px; border-radius: 8px; font-weight: 600;
            cursor: pointer; transition: all 0.2s; margin: 4px;
        }
        .btn:hover { background: #2563eb; transform: translateY(-1px); }
        .btn-pink { background: var(--pink); }
        .btn-pink:hover { background: #d81b60; }
        .activity-item {
            padding: 10px; background: rgba(59,130,246,0.1);
            border-radius: 6px; margin-bottom: 8px; font-size: 13px;
            border-left: 3px solid var(--primary);
        }
        .activity-time { color: var(--text-secondary); font-size: 11px; margin-top: 4px; }
        .timestamp {
            text-align: center; color: var(--text-secondary);
            font-size: 12px; margin-top: 20px;
        }
        .loading { text-align: center; padding: 40px; color: var(--text-secondary); }
        .notification {
            position: fixed; top: 80px; right: 20px; background: var(--surface);
            border: 1px solid var(--primary); border-radius: 8px; padding: 16px 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3); z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .modal {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7); z-index: 2000; align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--surface); border-radius: 12px; padding: 28px;
            max-width: 500px; width: 90%; border: 1px solid var(--border);
        }
        .modal-title { font-size: 20px; font-weight: 700; margin-bottom: 16px; }
        .modal-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px; }
        .input {
            width: 100%; padding: 12px; background: var(--bg); border: 1px solid var(--border);
            border-radius: 6px; color: var(--text); font-size: 14px; margin-bottom: 12px;
        }
        .input:focus { outline: none; border-color: var(--primary); }

    </style>
</head>
<body>
    <div class="header">
        <div style="display: flex; align-items: center; gap: 16px;">
            <div class="logo">üî® Forge Hub</div>
            <div class="version-badge" id="versionBadge">V6.3.1</div>
            <div class="status-dot" id="statusDot"></div>
        </div>
        <div style="color: white; font-weight: 500; font-size: 13px;">HYBRID SYSTEM</div>
    </div>
    
    <div class="container">
        <div class="alert">
            ‚ú® <strong>Smart Communication:</strong> Auto-routes commands via fastest available method 
            (GitHub Issues ‚ö° 3s, Email üìß 30s)
        </div>
        
        <div id="content" class="loading">Loading live data...</div>
        <div class="timestamp" id="timestamp"></div>
    </div>
    
    <!-- Command Modal -->
    <div class="modal" id="commandModal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle">Confirm Command</div>
            <div id="modalBody"></div>
            <div class="modal-actions">
                <button class="btn" onclick="closeModal()" style="background: #64748b;">Cancel</button>
                <button class="btn btn-pink" id="modalConfirm">Confirm</button>
            </div>
        </div>
    </div>
    
    <script>

        // Configuration
        const CONFIG = {
            github: {
                user: 'jessetprudhomme',
                repo: 'frontlineops-live',
                apiBase: 'https://api.github.com',
                rawBase: 'https://raw.githubusercontent.com'
            },
            email: {
                to: 'jesse.t.prudhomme@gmail.com',
                subject: '[FrontlineOps]'
            },
            refreshInterval: 10000 // 10 seconds
        };
        
        let state = null;
        let lastUpdate = null;
        let githubToken = localStorage.getItem('github_token');
        
        // Smart command router with auto-fallback
        async function sendCommand(command) {
            console.log('üì§ Sending command:', command);
            
            // ALWAYS use email for now (GitHub webhooks need backend setup)
            // GitHub token detection removed - using reliable email method
            sendViaEmail(command);
            showNotification('üìß Email opened - please send!\n\nForge will process in ~60 seconds', 'info');
            
            // Show helper message
            setTimeout(() => {
                showNotification('üí° Tip: Email method is reliable and works everywhere!', 'info');
            }, 2000);
        }
        
        // Method 1: Repository Dispatch (webhook)
        async function sendViaRepositoryDispatch(command) {
            const url = `${CONFIG.github.apiBase}/repos/${CONFIG.github.user}/${CONFIG.github.repo}/dispatches`;
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    event_type: command.action.toLowerCase().replace('_', '-'),
                    client_payload: command
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            console.log('‚úÖ Repository dispatch sent');
        }
        
        // Method 2: GitHub Issue
        async function sendViaGitHubIssue(command) {
            const url = `${CONFIG.github.apiBase}/repos/${CONFIG.github.user}/${CONFIG.github.repo}/issues`;
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    title: `[COMMAND] ${command.action}`,
                    body: '```json\n' + JSON.stringify(command, null, 2) + '\n```',
                    labels: ['forge-command']
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const issue = await response.json();
            console.log('‚úÖ GitHub issue created:', issue.number);
        }
        
        // Method 3: Email
        function sendViaEmail(command) {
            const subject = `${CONFIG.email.subject} ${command.action}`;
            const body = JSON.stringify(command, null, 2);
            window.location.href = `mailto:${CONFIG.email.to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        }
        
        // Fetch state from GitHub
        async function fetchState() {
            try {
                const url = `${CONFIG.github.rawBase}/${CONFIG.github.user}/${CONFIG.github.repo}/main/state.json?_=${Date.now()}`;
                const response = await fetch(url);
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                state = await response.json();
                lastUpdate = new Date();
                updateUI();
                document.getElementById('statusDot').style.background = '#10b981';
            } catch (error) {
                console.error('Fetch error:', error);
                document.getElementById('statusDot').style.background = '#ef4444';
                showError(error.message);
            }
        }
        
        // Update UI
        function updateUI() {
            if (!state) return;
            
            const iteration = state.iteration?.current || 0;
            const tests = state.tests?.phase_a?.passing || 0;
            const version = `V${state.version?.code || '6.3.1'}`;
            const phase = state.iteration?.phase || 'INIT';
            const task = state.forge_status?.current_task || 'Ready';
            
            let activityHTML = '';
            if (state.build_log && Array.isArray(state.build_log)) {
                activityHTML = state.build_log.slice(-8).reverse().map(log => {
                    const time = new Date(log.timestamp).toLocaleString();
                    return `
                        <div class="activity-item">
                            ${log.event}
                            <div class="activity-time">${time}</div>
                        </div>
                    `;
                }).join('');
            }
            
            const commMethod = 'üìß Email (Reliable)';
            
            document.getElementById('content').innerHTML = `
                <div class="grid">
                    <div class="card">
                        <div class="card-title">Current Iteration</div>
                        <div class="card-value">${iteration}</div>
                        <div class="card-label">of 20 total (${Math.round(iteration/20*100)}%)</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Tests Passed</div>
                        <div class="card-value">${tests}</div>
                        <div class="card-label">Phase A: ${tests}/50</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Version</div>
                        <div class="card-value">${version}</div>
                        <div class="card-label">${phase} Phase</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Communication</div>
                        <div class="card-value" style="font-size: 20px;">${commMethod}</div>
                        <div class="card-label">Auto-routed</div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-title">üéØ Current Task</div>
                    <div style="font-size: 15px; color: var(--text-secondary);">${task}</div>
                </div>
                
                <div class="section">
                    <div class="section-title">‚ö° Quick Actions</div>
                    <button class="btn btn-pink" onclick="startTest()">‚ñ∂Ô∏è Start Test</button>
                    <button class="btn" onclick="deployNow()">üöÄ Deploy Now</button>
                    <button class="btn" onclick="skipIteration()">‚è≠Ô∏è Skip Iteration</button>
                    <button class="btn" onclick="openApp()">üì± Open App</button>
                    <button class="btn" onclick="showEmailInfo()" style="background:#10b981;">‚ÑπÔ∏è How It Works</button>
                </div>
                
                <div class="section">
                    <div class="section-title">üìã Recent Activity</div>
                    ${activityHTML || '<div style="color: var(--text-secondary);">No recent activity</div>'}
                </div>
            `;
            
            updateTimestamp();
        }
        
        function updateTimestamp() {
            if (lastUpdate) {
                const age = Math.round((Date.now() - lastUpdate) / 1000);
                const nextRefresh = CONFIG.refreshInterval / 1000 - (age % (CONFIG.refreshInterval / 1000));
                document.getElementById('timestamp').textContent = 
                    `Last updated: ${lastUpdate.toLocaleTimeString()} (${age}s ago) ‚Ä¢ Next refresh in ${nextRefresh}s`;
            }
        }
        
        // Command functions
        function startTest() {
            showModal('Start Test', 'Start automated test Phase A?', () => {
                sendCommand({
                    action: 'START_TEST',
                    timestamp: new Date().toISOString(),
                    phase: 'A'
                });
            });
        }
        
        function deployNow() {
            showModal('Deploy Now', 'Deploy current version to GitHub Pages?', () => {
                sendCommand({
                    action: 'DEPLOY',
                    timestamp: new Date().toISOString()
                });
            });
        }
        
        function skipIteration() {
            const current = state?.iteration?.current || 0;
            showModal('Skip Iteration', `Skip iteration ${current} and move to ${current + 1}?`, () => {
                sendCommand({
                    action: 'SKIP_ITERATION',
                    timestamp: new Date().toISOString(),
                    current: current
                });
            });
        }
        
        function openApp() {
            window.open(`https://${CONFIG.github.user}.github.io/${CONFIG.github.repo}/frontlineops.html`, '_blank');
        }
        
        function connectGitHub() {
            const token = prompt('Enter GitHub Personal Access Token\n(Create at github.com/settings/tokens)\n\nNeeds: repo, workflow permissions');
            if (token && token.startsWith('ghp_')) {
                localStorage.setItem('github_token', token);
                githubToken = token;
                showNotification('GitHub connected! ‚úÖ', 'success');
                updateUI();
            }
        }
        
        // Modal functions
        function showModal(title, body, onConfirm) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').textContent = body;
            document.getElementById('modalConfirm').onclick = () => {
                closeModal();
                onConfirm();
            };
            document.getElementById('commandModal').classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('commandModal').classList.remove('active');
        }
        
        function showEmailInfo() {
            showModal('How Commands Work', 
                'Commands are sent via email to your Forge backend.\n\n' +
                '1. Click any action button\n' +
                '2. Email opens with command\n' +
                '3. Send the email\n' +
                '4. Forge processes (~60 seconds)\n' +
                '5. Hub auto-refreshes with result\n\n' +
                'Simple, reliable, works everywhere!',
                () => closeModal()
            );
        }
        
        // Notification
        function showNotification(message, type = 'info') {
            const notif = document.createElement('div');
            notif.className = 'notification';
            notif.textContent = message;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        }
        
        function showError(message) {
            document.getElementById('content').innerHTML = `
                <div style="background: var(--danger); color: white; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    ‚ùå Error loading data: ${message}<br><br>
                    <button class="btn" onclick="fetchState()">Retry</button>
                </div>
            `;
        }
        
        // Version badge click
        document.getElementById('versionBadge').addEventListener('click', function() {
            if (state && state.last_updated) {
                const date = new Date(state.last_updated);
                const original = this.textContent;
                this.textContent = date.toLocaleString('en-US', {
                    month: 'short', day: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });
                setTimeout(() => { this.textContent = original; }, 3000);
            }
        });
        
        // Initialize
        fetchState();
        setInterval(fetchState, CONFIG.refreshInterval);
        setInterval(updateTimestamp, 1000);
        
        console.log('üî® Forge Hub initialized');
        console.log('Communication mode:', githubToken ? 'GitHub (fast)' : 'Email (fallback)');
    </script>
</body>
</html>

